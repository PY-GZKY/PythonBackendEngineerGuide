# 如何优化后端服务的性能

## 如何对 FastAPI 框架进行性能优化?

### 1. 在合适的地方使用异步方法

在 FastAPI 中，可以使用异步方法来提高性能。比如在处理请求时，特别是一些 I/O 密集型的操作，可以使用异步方法来处理，这样可以提高并发处理能力。

### 2. 使用多进程部署充分利用多核 CPU

uvicorn 默认使用单进程处理请求，可以通过设置 `--workers` 参数来启动多个进程，充分利用多核 CPU。

```shell
uvicorn main:app --workers 4
```

## 如何在生产环境中优化数据库性能？

### 为什么要创建数据库索引？

数据库索引可以提高查询的效率，减少数据库系统的负载。当我们查询数据库时，数据库系统会首先检查索引，然后根据索引的信息来定位数据，从而减少查询的时间。

常见的索引类型有单列索引、多列索引（组合索引）、唯一索引、主键索引等。

### 如何创建数据库索引？

在创建数据库表时，我们可以为表的某些列创建索引。例如，我们可以为用户表的用户名列创建索引，以提高查询用户信息的效率。

例如有一个用户表的表结构如下：

```sql
CREATE TABLE users
(
    id         INT PRIMARY KEY,
    username   VARCHAR(255),
    email      VARCHAR(255),
    password   VARCHAR(255),
    created_at TIMESTAMP
);
```

我们假设这个表有100万条记录，我们要查询用户名为`test123`的用户信息，如果没有索引，数据库系统会逐条扫描表中的记录，
直到找到用户名为`admin`的记录。这样的查询效率非常低。

下面我们为用户表的`username`列创建一个索引：

```sql
CREATE INDEX idx_username ON users (username);
```

上面的语句创建了一个名为`idx_username`的索引，该索引是对`users`表的`username`列进行索引，这是一个单列索引。

如果我们想要查询 username 和 email 列的组合信息，比如查询用户名为`test123`且邮箱为`test123@qq.com`的用户信息，我们可以创建一个组合索引：

```sql
CREATE INDEX idx_username_email ON users (username, email);
```

这是一个多列索引，使用场景是查询 username 和 email 列的组合信息。它和分别创建单列索引的区别是：

- 单列索引只能用于查询单列信息，而多列索引可以用于查询多列信息
- 多列索引的查询效率高于单列索引，因为多列索引可以减少数据库系统的扫描次数

...

### 如何设置  MySQL 的 wait_timeout?

`wait_timeout` 是 MySQL 中的一个系统变量，用于设置客户端连接的超时时间，即连接在空闲一段时间后会自动断开。

这个变量的默认值是 `28800` 秒（8 小时），也就是说，如果一个客户端连接在 8 小时内没有任何活动，那么 MySQL 会自动断开这个连接。

但是有时候我们不希望数据库在闲置 8 小时之后才断开连接，如果我的后台服务并发性较高，那么 8 小时的时间可能会导致数据库连接数过多，从而影响数据库的性能。

在 MySQL 中，可以通过以下方式设置 `wait_timeout` 变量：

```shell
SHOW SESSION VARIABLES LIKE 'wait_timeout';
```

然后，你需要找到启动 MySQL 的配置文件，通常是 `my.cnf` 或 `my.ini`，在这个文件中修改或添加以下配置：

```shell
[mysqld]
wait_timeout = 14400
```

这里的 `14400` 是你希望设置的超时时间，单位是秒。修改完配置文件后，重启 MySQL 服务，新的 `wait_timeout` 设置就会生效。

设置 `wait_timeout` 的目的是为了优化数据库的性能和资源利用，避免因为连接数过多而导致数据库性能下降。

设置过小的 `wait_timeout` 可能会导致一些问题，比如客户端连接频繁断开、连接池无法正常工作等，因此需要根据实际情况来合理设置这个值。
